<html>

<head>
  <title>Text Sync</title>
</head>

<body>
  <script type="importmap">
    {
      "imports": {
        "solid-js": "https://esm.sh/solid-js@1.9.3",
        "solid-js/": "https://esm.sh/solid-js@1.9.3/",
        "qrcode": "https://esm.sh/qrcode@1.5.4"
      }
    }
  </script>
  <script type="module">
    import { createSignal, createEffect, onCleanup } from "solid-js";
    import { render } from "solid-js/web";
    import html from "solid-js/html";
    import qrcode from "qrcode";

    const App = () => {
      // key
      const [key, setKey] = createSignal('')
      const url = () => `${location.origin}/${key()}`

      function onInputKey(e) {
        setKey(e.target.value)
        setValue('')
        history.replaceState({}, '', url())
      }

      function generateKey() {
        setKey(new Array(6).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join(''))
        setValue('')
        history.replaceState({}, '', url())
      }

      // value
      const [value, setValue] = createSignal('')
      function onUpdateValue(e) {
        setValue(e.target.value)
      }

      async function updateValue() {
        const res = await fetch('/api/text', {
          method: 'post',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ key: key(), value: value() })
        })
        if (res.status !== 200) {
          alert(`Failed to update: ${res.status} ${res.statusText}`)
        }
      }

      async function refreshValue() {
        const res = await fetch('/api/text', {
          method: 'get',
        })
        if (res.status !== 200) {
          alert(`Failed to update: ${res.status} ${res.statusText}`)
        }
        const { data } = await res.json()
        setValue(data)
      }

      // qrcode
      const qrcodeImg = html`<${Qrcode} text=${url} />`

      // app
      return html`
        <div style="padding: 32px; display: flex; flex-direction: column; align-items: center; gap: 16px;">
          <div style="display: flex; gap: 8px;">
            <input placeholder="Key" value=${key} onInput=${onInputKey} />
            <button onClick=${generateKey}>Generate</button>
          </div>
          ${() => key() && qrcodeImg}
          <textarea placeholder="Value" value=${value} onInput=${onUpdateValue} style="height: 200px; width: 100%;" />
          <div style="display: flex; gap: 8px;">
            <button onClick=${updateValue} disabled=${() => !Boolean(key())}>Update</button>  
            <button onClick=${refreshValue} disabled=${() => !Boolean(key())}>Refresh</button>  
          </div>
        </div>
      `;
    };

    const Qrcode = (props) => {
      const [dataUrl, setDataUrl] = createSignal('')

      createEffect(async () => {
        setDataUrl(await qrcode.toDataURL(props.text))
      })

      return html`
        <img src=${dataUrl} style="width: 120px;" />
      `      
    }

    render(App, document.body);
  </script>
</body>

</html>
